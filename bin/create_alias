#!/bin/bash
usage() {
	echo "Usage: $0 user@somedomain.com user@someotherdomain.com [container name]"
}
if [ -z $1 ]; then usage; exit 1; fi
email=$1
username=$(cut -f1 -d@ <<<$email);
domain=$(cut -f2 -d@ <<<$email);
alias_email=$2
alias_domain=$(cut -f1 -d@ <<<$alias_email);
alias_username=$(cut -f2 -d@ <<<$alias_email);
container_name=$3
vmail_dir=$(docker exec -ti $container_name postconf | grep ^virtual_mailbox_base | awk '{print $NF}');
valiases=$(docker exec -ti $container_name postconf | grep ^virtual_alias_maps | awk -F: '{print $NF}');
if [ -f $valiases ]; then
	if ! grep -q "$alias_email" $valiases; then
		if [[ -d $vmail_dir/$alias_domain/$alias_username ]]; then
			echo -n "Adding alias for $email to forward to $alias_email.."
			echo "$email $alias_email" >> $valiases
			echo "done."
			echo "Restart Docker container to reload configuration changes."
		else
			echo "The alias mailbox does not exist ($vmail_dir/$alias_domain/$alias_username)!"
			exit 1
		fi
	else
		echo "Alias $alias_email already exists in the virtual aliases configuration file. Maybe you need to restart the Docker container?"
		exit 1
	fi
	echo "Alias configuration file ($valiases) could not be found!"
	exit 1
fi
