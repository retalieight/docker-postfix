#!/bin/bash
usage() {
	echo "Usage: $0 somedomain.com [container name]"
}
if [ -z $1 ]; then usage; exit 1; fi
domain=$1
container_name=$2
vmail_dir=$(docker exec -ti $container_name postconf | grep virtual_mailbox_base | awk '{print $NF}');
if [[ ! -z $vmail_dir ]] && [[ -d $vmail_dir ]]; then
	if ! grep -q "$domain" $vmail_dir/virtual_domains; then
		echo -n "Adding domain $domain to virtual domain configuration file ($vmail_dir/virtual_domains).."
		echo "$domain" >> $vmail_dir/virtual_domains
		echo "done."
		echo "Restart Docker container to reload configuration changes."
	else
		echo "Domain $domain already exists in the virtual domain configuration file. Maybe you need to restart the Docker container?"
	fi
else
	echo "Virtual mailbox directory ($vmail_dir) does not exist! Check your Docker volume path."
        echo "docker exec -ti postfix /bin/sh"
        echo "postconf | grep virtual_mailbox_base"
	exit 1
fi
